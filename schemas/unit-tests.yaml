name: Workflow de Testes Unitários

groups:
  on_group:
    label: Eventos
    description: Define os eventos que disparam os testes unitários
    fields:
      on:
        label: "Eventos"
        type: list
        itemType: string
        required: true
        help: "Eventos que acionam o workflow (ex: push, pull_request)"
        defaultValues:
          - push
          - pull_request
          - pull_request_target
          - issues
          - issue_comment
          - fork
          - release
          - schedule
          - workflow_dispatch
          - workflow_call
          - repository_dispatch
          - discussion
          - discussion_comment
          - deployment
          - deployment_status
          - workflow_run
          - create
          - delete
          - label
          - milestone
          - project
          - project_card
          - project_column
          - page_build
          - watch
          - membership
          - check_run
          - check_suite
          - commit_comment
          - gollum
          - member
          - public
          - pull_request_review
          - pull_request_review_comment
          - registry_package
          - status
          - team
          - team_add
          - content_reference
          - merge_group
          - projects_v2_item
          - registry_package
          - secret_scanning_alert
          - security_advisory
          - sponsorship
          - repository_import
          - repository_vulnerability_alert
          - deployment_protection_rule
      branches:
        label: "Branches"
        type: list
        itemType: string
        required: false
        help: "Branches nas quais o workflow deve rodar"
        defaultValues:
          - main
          - master
          - feature
          - prod

  jobs_group:
    label: Jobs
    description: Define os jobs de execução dos testes unitários
    repeatable: true
    fields:
      jobs:
        label: "Jobs"
        type: object
        required: true
        nameableKey: true
        fields:
          runs-on:
            label: "Sistema Operacional"
            type: string
            required: true
            help: "Sistema operacional do job (ex: ubuntu-latest)"
            defaultValues:
              - ubuntu-latest
              - ubuntu-24.04
              - ubuntu-22.04
              - ubuntu-20.04
              - windows-latest
              - windows-2022
              - windows-2019
              - macos-latest
              - macos-15
              - macos-14
              - macos-13
              - macos-12
          steps:
            label: "Etapas"
            type: list
            itemType: object
            required: true
            help: "Etapas executadas no job"
            fields:
              name:
                label: "Nome da Etapa"
                type: string
                required: true
                help: "Nome da etapa"
              run:
                label: "Comando"
                type: string
                required: false
                help: "Comando executado na etapa (ex: npm test)"
              uses:
                label: "Ação Reutilizável"
                type: string
                required: false
                help: "Ação reutilizável do GitHub (ex: actions/checkout@v3)"
                defaultValues:
                  - actions/checkout@v4
                  - actions/setup-node@v4
                  - actions/setup-python@v5
              with:
                label: "Parâmetros"
                type: object
                required: false
                help: "Parâmetros para a ação reutilizável"

  reports_group:
    label: Relatórios
    description: Relatórios e cobertura de testes unitários
    fields:
      reports:
        label: "Relatórios"
        type: list
        itemType: string
        required: false
        help: "Caminhos ou formatos de relatórios gerados (ex: junit, lcov, cobertura.xml)"
        defaultValues:
          - junit
          - allure
      coverage:
        label: "Cobertura"
        type: string
        required: false
        help: "Caminho ou formato do relatório de cobertura de código (ex: coverage/lcov.info)"

rules:
  required-job:
    description: O workflow deve conter ao menos um job
    condition: $count(groups.jobs_group.fields.jobs) > 0
    error: É necessário definir ao menos um job de testes unitários

  required-test-step:
    description: Cada job deve possuir ao menos uma etapa que rode os testes unitários
    condition: >
      $exists(groups.jobs_group.fields.jobs.fields.steps.fields.run ~> /.*(jest|mocha|pytest|unittest|test).*/i)
    error: Cada job precisa incluir uma etapa que execute testes unitários

  required-report:
    description: É recomendado que haja ao menos um relatório de cobertura
    condition: $count(groups.reports_group.fields.coverage) > 0
    error: Nenhum relatório de cobertura foi definido